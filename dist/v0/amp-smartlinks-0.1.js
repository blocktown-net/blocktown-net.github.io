(self.AMP=self.AMP||[]).push({n:"amp-smartlinks",v:"1910151804560",f:(function(AMP,_){
var aa="function"==typeof Object.create?Object.create:function(a){function b(){}b.prototype=a;return new b},k;if("function"==typeof Object.setPrototypeOf)k=Object.setPrototypeOf;else{var m;a:{var ba={a:!0},n={};try{n.__proto__=ba;m=n.a;break a}catch(a){}m=!1}k=m?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null}var p=k;
function q(a,b){a.prototype=aa(b.prototype);a.prototype.constructor=a;if(p)p(a,b);else for(var c in b)if("prototype"!=c)if(Object.defineProperties){var d=Object.getOwnPropertyDescriptor(b,c);d&&Object.defineProperty(a,c,d)}else a[c]=b[c];a.ka=b.prototype}var ca=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a}(this);function da(){var a,b;this.promise=new Promise(function(c,d){a=c;b=d});this.resolve=a;this.reject=b};function r(a,b){b=void 0===b?"":b;try{return decodeURIComponent(a)}catch(c){return b}};var ea=/(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/g;self.__AMP_LOG=self.__AMP_LOG||{user:null,dev:null,userForEmbed:null};var t=self.__AMP_LOG;function u(a){return a||{}};u({c:!0,v:!0,a:!0,ad:!0,action:!0});function fa(a){var b="macro-after-long-task";if(a.__AMP__EXPERIMENT_TOGGLES)var c=a.__AMP__EXPERIMENT_TOGGLES;else{a.__AMP__EXPERIMENT_TOGGLES=Object.create(null);c=a.__AMP__EXPERIMENT_TOGGLES;if(a.AMP_CONFIG)for(var d in a.AMP_CONFIG){var e=a.AMP_CONFIG[d];"number"===typeof e&&0<=e&&1>=e&&(c[d]=Math.random()<e)}if(a.AMP_CONFIG&&Array.isArray(a.AMP_CONFIG["allow-doc-opt-in"])&&0<a.AMP_CONFIG["allow-doc-opt-in"].length&&(d=a.AMP_CONFIG["allow-doc-opt-in"],e=a.document.head.querySelector('meta[name="amp-experiments-opt-in"]'))){e=
e.getAttribute("content").split(",");for(var f=0;f<e.length;f++)-1!=d.indexOf(e[f])&&(c[e[f]]=!0)}Object.assign(c,ha(a));if(a.AMP_CONFIG&&Array.isArray(a.AMP_CONFIG["allow-url-opt-in"])&&0<a.AMP_CONFIG["allow-url-opt-in"].length){d=a.AMP_CONFIG["allow-url-opt-in"];e=a.location.originalHash||a.location.hash;a=Object.create(null);if(e)for(var g;g=ea.exec(e);)f=r(g[1],g[1]),g=g[2]?r(g[2].replace(/\+/g," "),g[2]):"",a[f]=g;for(e=0;e<d.length;e++)f=a["e-"+d[e]],"1"==f&&(c[d[e]]=!0),"0"==f&&(c[d[e]]=!1)}}var h=
c;return!!h[b]}function ha(a){var b="";try{"localStorage"in a&&(b=a.localStorage.getItem("amp-experiment-toggles"))}catch(e){if(t.dev)a=t.dev;else throw Error("failed to call initLogConstructor");a.warn("EXPERIMENTS","Failed to retrieve experiments from localStorage.")}var c=b?b.split(/\s*,\s*/g):[];a=Object.create(null);for(var d=0;d<c.length;d++)0!=c[d].length&&("-"==c[d][0]?a[c[d].substr(1)]=!1:a[c[d]]=!0);return a};function v(a,b){a=a.__AMP_TOP||(a.__AMP_TOP=a);return w(a,b)}function x(a,b){var c=y(a);c=z(c);return w(c,b)}function y(a){return a.nodeType?v((a.ownerDocument||a).defaultView,"ampdoc").getAmpDoc(a):a}function z(a){a=y(a);return a.isSingleDoc()?a.win:a}function w(a,b){var c=A(a);a=c[b];a.obj||(a.obj=new a.ctor(a.context),a.ctor=null,a.context=null,a.resolve&&a.resolve(a.obj));return a.obj}function B(a,b){var c=C(a,b);if(c)return c;a=A(a);a[b]=ia();return a[b].promise}
function C(a,b){var c=A(a)[b];if(c){if(c.promise)return c.promise;w(a,b);return c.promise=Promise.resolve(c.obj)}return null}function A(a){var b=a.__AMP_SERVICES;b||(b=a.__AMP_SERVICES={});return b}function ia(){var a=new da,b=a,c=b.promise,d=b.resolve;b=b.reject;c.catch(function(){});return{obj:null,promise:c,resolve:d,reject:b,context:null,ctor:null}};/*
 https://mths.be/cssescape v1.5.1 by @mathias | MIT license */
function D(a,b,c){a=a.createElement(b);for(var d in c)a.setAttribute(d,c[d]);return a};function E(a){var b=C(z(a),"amp-analytics-instrumentation");if(b)return b;var c=y(a);return c.waitForBodyOpen().then(function(){var a=c.win;var b=c.win.document.head;if(b){var f={};b=b.querySelectorAll("script[custom-element],script[custom-template]");for(var g=0;g<b.length;g++){var h=b[g];h=h.getAttribute("custom-element")||h.getAttribute("custom-template");f[h]=!0}f=Object.keys(f)}else f=[];a=f.includes("amp-analytics")?v(a,"extensions").waitForExtension(a,"amp-analytics"):Promise.resolve();return a}).then(function(){var b=
c.win;return b.__AMP_EXTENDED_ELEMENTS&&b.__AMP_EXTENDED_ELEMENTS["amp-analytics"]?B(z(a),"amp-analytics-instrumentation"):null})};function ja(a,b,c){E(a).then(function(d){d&&d.triggerEventForTarget(a,b,c)})};function ka(a,b){var c=!0;c=void 0===c?!1:c;var d=void 0===d?!1:d;var e=a.ownerDocument,f=D(e,"amp-analytics",u({sandbox:"true",trigger:d?"":"immediate"})),g=D(e,"script",u({type:"application/json"}));g.textContent=JSON.stringify(b);f.appendChild(g);f.CONFIG=b;c?(b=v(a.ownerDocument.defaultView,"extensions"),c=y(a),b.installExtensionForDoc(c,"amp-analytics")):E(a).then(function(){});a.appendChild(f)}
function F(a,b){var c=this;this.T=a.getResourceId();this.G=a;this.B=b;for(var d in b.triggers){var e="sandbox-"+this.T+"-"+b.triggers[d].on;b.triggers[d].on=e}this.G.signals().whenSignal("load-start").then(function(){ka(c.G,b)})}F.prototype.trigger=function(a,b){ja(this.G,"sandbox-"+this.T+"-"+a,b)};function G(a){this.G=a;this.B={requests:{},triggers:{}}}G.prototype.setTransportConfig=function(a){this.B.transport=a};G.prototype.setExtraUrlParams=function(a){this.B.extraUrlParams=a};
G.prototype.track=function(a,b){b=Array.isArray(b)?b:[b];for(var c=[],d=0;d<b.length;d++){var e=a+"-request-"+d;this.B.requests[e]=b[d];c.push(e)}this.B.triggers[a]={on:a,request:c};return this};G.prototype.build=function(){var a=new F(this.G,this.B);this.B=null;return a};var H,I="Webkit webkit Moz moz ms O o".split(" ");var K=!1;function L(){this.l=[]}L.prototype.peek=function(){var a=this.l.length;return a?this.l[a-1].item:null};L.prototype.enqueue=function(a,b){if(isNaN(b))throw Error("Priority must not be NaN.");for(var c=b,d=-1,e=0,f=this.l.length;e<=f;){d=Math.floor((e+f)/2);if(d===this.l.length)break;if(this.l[d].priority<c)e=d+1;else if(0<d&&this.l[d-1].priority>=c)f=d-1;else break}this.l.splice(d,0,{item:a,priority:b})};L.prototype.forEach=function(a){for(var b=this.l.length;b--;)a(this.l[b].item)};
L.prototype.dequeue=function(){return this.l.length?this.l.pop().item:null};ca.Object.defineProperties(L.prototype,{length:{configurable:!0,enumerable:!0,get:function(){return this.l.length}}});var la=/nochunking=1/.test(self.location.hash),M=Promise.resolve();function ma(a,b){if(la)M.then(b);else{var c=N,d=y(a),e=z(d),f=A(e),g=f.chunk;g||(g=f.chunk={obj:null,promise:null,resolve:null,reject:null,context:null,ctor:null});g.ctor||g.obj||(g.ctor=c,g.context=d,g.resolve&&w(e,"chunk"));x(a,"chunk").run(b,10)}}function O(a){this.state="not_run";this.L=a}function na(a,b){if("run"!=a.state){a.state="run";try{a.L(b)}catch(c){throw a.X(),c;}}}
O.prototype.ja=function(){return this.L.displayName||this.L.name};O.prototype.X=function(){};O.prototype.U=function(){return!1};O.prototype.$=function(){return!1};function P(a,b,c){O.call(this,a);this.P=c}q(P,O);
P.prototype.X=function(){var a=self.document;if(!K){K=!0;a=a.body;var b={opacity:1,visibility:"visible",animation:"none"},c;for(c in b){var d=a,e=b[c];var f=d.style;var g=c;if(2>g.length?0:0==g.lastIndexOf("--",0))f=g;else{H||(H=Object.create(null));var h=H[g];if(!h){h=g;if(void 0===f[g]){var l=g;l=l.charAt(0).toUpperCase()+l.slice(1);b:{for(var J=0;J<I.length;J++){var X=I[J]+l;if(void 0!==f[X]){l=X;break b}}l=""}void 0!==f[l]&&(h=l)}H[g]=h}f=h}f&&(d.style[f]=e)}}};P.prototype.U=function(){return this.P.ampdoc.isVisible()};
P.prototype.$=function(){return this.P.R};function N(a){var b=this;this.ampdoc=a;this.C=a.win;this.D=new L;this.O=this.S.bind(this);this.F=0;this.ca=fa(this.C);this.K=!1;this.aa=this.C.document.documentElement.hasAttribute("i-amphtml-no-boilerplate");this.C.addEventListener("message",function(a){"amp-macro-task"==a.data&&b.S(null)});this.R=!1;B(z(a),"viewer").then(function(){b.R=!0});a.onVisibilityChanged(function(){a.isVisible()&&Q(b)})}
N.prototype.run=function(a,b){var c=new O(a);this.D.enqueue(c,b);Q(this)};N.prototype.runForStartup=function(a){a=new P(a,this.C,this);this.D.enqueue(a,Number.POSITIVE_INFINITY);Q(this)};function R(a,b){for(var c=a.D.peek();c&&"not_run"!==c.state;)a.D.dequeue(),c=a.D.peek();c&&b&&a.D.dequeue();return c}
N.prototype.S=function(a){var b=this,c=R(this,!0);if(!c)return this.K=!1,this.F=0,!1;try{var d=Date.now();na(c,a)}finally{M.then().then().then().then().then().then().then().then().then(function(){b.K=!1;b.F+=Date.now()-d;Q(b)})}return!0};function oa(a){a.ca&&a.aa&&5<a.F?(a.F=0,S(a)):M.then(function(){a.O(null)})}function Q(a){if(!a.K){var b=R(a);b&&(b.U()?(a.K=!0,oa(a)):b.$()&&a.C.requestIdleCallback?pa(a.C,a.O):S(a))}}function S(a){a.C.postMessage("amp-macro-task","*")}
function pa(a,b){function c(f){if(f.timeRemaining()<d){var g=2E3-(Date.now()-e);0>=g||f.didTimeout?b(f):a.requestIdleCallback(c,{timeout:g})}else b(f)}var d=15,e=Date.now();a.requestIdleCallback(c,{timeout:2E3})};function T(){this.m=[];this.N=[]}T.prototype.updateLinkList=function(a){this.N=a.map(this.getReplacementUrlForAnchor.bind(this));this.m=a};T.prototype.updateReplacementUrls=function(a){var b=this;a.forEach(function(a){var c=a.anchor,e=a.replacementUrl,f=b.m.indexOf(c);-1!==f&&(b.N[f]=e)})};T.prototype.getReplacementUrlForAnchor=function(a){a=this.m.indexOf(a);return-1!==a?this.N[a]:null};T.prototype.isInCache=function(a){return-1!==this.m.indexOf(a)};
T.prototype.getAnchorReplacementList=function(){var a=this;return this.m.map(function(b){return{anchor:b,replacementUrl:a.getReplacementUrlForAnchor(b)}})};function U(){this.j=null}U.prototype.add=function(a){var b=this;this.j||(this.j=[]);this.j.push(a);return function(){b.remove(a)}};U.prototype.remove=function(a){this.j&&(a=this.j.indexOf(a),-1<a&&this.j.splice(a,1))};U.prototype.removeAll=function(){this.j&&(this.j.length=0)};U.prototype.fire=function(a){if(this.j)for(var b=this.j,c=0;c<b.length;c++)(0,b[c])(a)};U.prototype.getHandlerCount=function(){return this.j?this.j.length:0};function V(a,b){this.syncResponse=a;this.asyncResponse=b};function W(a,b,c,d){this.events=new U;this.id=b;this.w=a;this.ha=c;this.ba=d.linkSelector||"a";this.ia=300;this.A=new T}W.prototype.getReplacementUrl=function(a){return this.isWatchingLink(a)?this.A.getReplacementUrlForAnchor(a):null};W.prototype.getAnchorReplacementList=function(){return this.A.getAnchorReplacementList()};W.prototype.isWatchingLink=function(a){return this.A.isInCache(a)};
W.prototype.rewriteAnchorUrl=function(a){var b=this.getReplacementUrl(a);if(!b||b===a.href)return!1;a.setAttribute("data-link-rewriter-original-url",a.href);a.href=b;setTimeout(function(){a.href=a.getAttribute("data-link-rewriter-original-url");a.removeAttribute("data-link-rewriter-original-url")},this.ia);return!0};
W.prototype.onDomUpdated=function(){var a=this;return new Promise(function(b){var c=a.w.nodeType==Node.DOCUMENT_NODE?a.w.documentElement:a.w;ma(c,function(){return qa(a).then(function(){a.events.fire({type:"PAGE_SCANNED"});b()})})})};
function qa(a){var b=ra(a),c=sa(a,b);a.A.updateLinkList(b);if(!c.length)return Promise.resolve();a.A.updateReplacementUrls(c.map(function(a){return{anchor:a,replacementUrl:null}}));var d=a.ha(c);if(!t.user)throw Error("failed to call initLogConstructor");t.user.assert(d instanceof V,'Invalid response from provided "resolveUnknownLinks" function."resolveUnknownLinks" should return an instance of TwoStepsResponse',void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0);d.syncResponse&&a.A.updateReplacementUrls(d.syncResponse);
return d.asyncResponse?d.asyncResponse.then(function(b){a.A.updateReplacementUrls(b)}):Promise.resolve()}function sa(a,b){var c=[];b.forEach(function(b){a.isWatchingLink(b)||c.push(b)});return c}function ra(a){var b=a.w.querySelectorAll(a.ba);return[].slice.call(b)};function Y(a){this.w=a.getRootNode();var b=x(a,"documentInfo").get().metaTags["amp-link-rewriter-priorities"];this.ea=b?b.trim().split(/\s+/):[];this.M=[];this.w.addEventListener("amp:dom-update",this.da.bind(this));var c=x(a,"navigation");c.registerAnchorMutator(this.maybeRewriteLink.bind(this),0)}Y.prototype.registerLinkRewriter=function(a,b,c){var d=new W(this.w,a,b,c);ta(this.M,d,this.ea);d.onDomUpdated();return d};
Y.prototype.maybeRewriteLink=function(a,b){var c=ua(this,a);if(c.length){for(var d=null,e=0;e<c.length;e++){var f=c[e].rewriteAnchorUrl(a);if(f){d=c[e];break}}var g={linkRewriterId:d?d.id:null,anchor:a,clickType:b.type};c.forEach(function(a){a.events.fire({type:"CLICK",eventData:g})})}};Y.prototype.da=function(){this.M.forEach(function(a){a.onDomUpdated()})};function va(a){var b=a.hasAttribute("data-link-rewriters")?a.getAttribute("data-link-rewriters").trim():null;return b?b.split(/\s+/):[]}
function ta(a,b,c){function d(a,b){var d=c.indexOf(a.id),g=c.indexOf(b.id);return-1===d&&-1===g?0:-1===d?e:-1===g?f:d>g?e:f}var e=1,f=-1;a.push(b);a.sort(d)}function ua(a,b){var c=va(b);return a.M.reduce(function(a,e){e.isWatchingLink(b)&&ta(a,e,c);return a},[])};function wa(a,b){var c=void 0===c?5:c;if(!isFinite(c)||0>c)throw Error("Invalid depth: "+c);if(a===b)return!0;for(a=[{a:a,b:b,depth:c}];0<a.length;){var d=a.shift();b=d.a;c=d.b;d=d.depth;if(0<d){if(typeof b!==typeof c)return!1;if(Array.isArray(b)&&Array.isArray(c)){if(b.length!==c.length)return!1;for(var e=0;e<b.length;e++)a.push({a:b[e],b:c[e],depth:d-1});continue}else if(b&&c&&"object"===typeof b&&"object"===typeof c){var f=Object.keys(b),g=Object.keys(c);if(f.length!==g.length)return!1;for(e=0;e<
f.length;e++){var h=f[e];a.push({a:b[h],b:c[h],depth:d-1})}continue}}if(b!==c)return!1}return!0};function xa(a,b,c){this.h=a;this.H=b;this.ga=c.exclusiveLinks;this.fa=c.publisherID;this.I=c.linkAttribute;this.w=this.h.getRootNode();this.J=this.m=null}xa.prototype.runLinkmate=function(a){var b=this,c=null,d=this.m&&!wa(this.m,a);this.J&&d&&(c=ya(this));if(!this.J||d){var e=za(this,a).then(function(c){b.J=c.data[0].smart_links;b.m=a;return ya(b)});return new V(c,e)}this.m=a;return new V(c,null)};
function za(a,b){var c=Aa(a,b),d=u({name:a.w.title||null,url:a.h.getUrl()});b=u({article:d,links:c});var e="https://api.narrativ.com/api/v1/publishers/.pub_id./linkmate/smart_links/".replace(".pub_id.",a.fa.toString()),f={method:"POST",ampCors:!1,headers:u({"Content-Type":"application/json"}),body:b};return a.H.fetchJson(e,f).then(function(a){return a.json()})}
function Aa(a,b){var c=[];b.forEach(function(b){var d=b.getAttribute(a.I);if(/shop-links.co/.test(d))/\?amp=true$/.test(d)||(b[a.I]+="?amp=true");else if(!/#donotlink$/.test(d)){var f=a.ga||/#locklink$/.test(d),g={raw_url:d,exclusive_match_requested:f};c.push(g)}});return c}function ya(a){var b=[];a.m.forEach(function(c){a.J.forEach(function(d){c.getAttribute(a.I)===d.url&&d.auction_id&&b.push({anchor:c,replacementUrl:"https://shop-links.co/"+d.auction_id+"/?amp=true"})})});return b};function Ba(a){var b=a.getAttribute("nrtv-account-name").toLowerCase();var c=!!a.hasAttribute("linkmate"),d=!!a.hasAttribute("exclusive-links");var e=(e=a.getAttribute("link-attribute"))?e.toLowerCase():"href";a=(a=a.getAttribute("link-selector"))?a.toLowerCase():"a";return{nrtvSlug:b,linkmateEnabled:c,exclusiveLinks:d,linkAttribute:e,linkSelector:a}};function Z(a){a=AMP.BaseElement.call(this,a)||this;a.H=null;a.h=null;a.V=null;a.Z=null;a.o=null;a.W=null;a.Y=null;return a}q(Z,AMP.BaseElement);Z.prototype.buildCallback=function(){var a=this;this.h=this.getAmpDoc();this.H=v(this.h.win,"xhr");var b=x(this.h,"viewer");this.o=Ba(this.element);this.V=new Y(this.h);return this.h.whenReady().then(function(){return b.getReferrerUrl()}).then(function(b){a.Y=b;a.h.whenFirstVisible().then(function(){Ca(a)})})};
function Ca(a){Da(a).then(function(b){a.o.linkmateExpected=b.linkmate_enabled;a.o.publisherID=b.publisher_id;a.signals().signal("load-start");b=u({events:[{is_amp:!0}],organization_id:a.o.publisherID,organization_type:"publisher",user:{page_session_uuid:Ea(),source_url:a.h.getUrl(),previous_url:a.Y,user_agent:a.h.win.navigator.userAgent}});var c=new G(a.element);c.track("page-impression","https://api.narrativ.com/api/v1/events/impressions/page_impression/");c.setTransportConfig(u({beacon:!0,image:!1,
xhrpost:!0,useBody:!0}));c.setExtraUrlParams(b);c.build().trigger("page-impression");a.W=new xa(a.h,a.H,a.o);a.Z=Fa(a);a.o.linkmateEnabled&&a.o.linkmateExpected&&a.Z.getAnchorReplacementList()})}function Da(a){var b="https://api.narrativ.com/api/v0/publishers/.nrtv_slug./amp_config/".replace(".nrtv_slug.",a.o.nrtvSlug);try{return a.H.fetchJson(b,{method:"GET",ampCors:!1}).then(function(a){return a.json()}).then(function(a){return a.data[0].amp_config})}catch(c){return null}}
function Fa(a){return a.V.registerLinkRewriter("amp-smartlinks",function(b){return a.W.runLinkmate(b)},{linkSelector:a.o.linkSelector})}function Ea(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,function(a){return(a^crypto.getRandomValues(new Uint8Array(1))[0]&15>>a/4).toString(16)})}(function(a){a.registerElement("amp-smartlinks",Z)})(self.AMP);
})});

//# sourceMappingURL=amp-smartlinks-0.1.js.map
